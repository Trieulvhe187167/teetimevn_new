{% extends 'owner/layout.html' %}

{% block owner_content %}
<div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4">
  <div>
    <h1 class="h4 fw-semibold mb-1">{{ _('Booking management') }}</h1>
    <p class="text-muted mb-0">{{ _('Review and control every reservation for your courses.') }}</p>
  </div>
  <a href="{{ url_for('owner.checkins', lang=lang) }}" class="btn btn-outline-success mt-3 mt-md-0">
    <i class="bi bi-person-check me-2"></i>{{ _('Go to check-in board') }}
  </a>
</div>

<div class="row g-3 mb-4">
  <div class="col-sm-6 col-lg-3">
    <div class="card border-0 shadow-sm h-100 bg-warning-subtle">
      <div class="card-body">
        <small class="text-uppercase text-muted">{{ _('Pending') }}</small>
        <div class="display-6 fw-bold text-warning">{{ stats.pending }}</div>
      </div>
    </div>
  </div>
  <div class="col-sm-6 col-lg-3">
    <div class="card border-0 shadow-sm h-100 bg-success-subtle">
      <div class="card-body">
        <small class="text-uppercase text-muted">{{ _('Confirmed') }}</small>
        <div class="display-6 fw-bold text-success">{{ stats.confirmed }}</div>
      </div>
    </div>
  </div>
</div>

<form method="get" class="card border-0 shadow-sm mb-4 p-3">
  <div class="row g-3 align-items-end">
    <div class="col-md-4">
      <label for="course_id" class="form-label small text-uppercase text-muted">{{ _('Course') }}</label>
      <select name="course_id" id="course_id" class="form-select">
        <option value="">{{ _('All courses') }}</option>
        {% for course in courses %}
          <option value="{{ course.id }}" {% if filters.course_id == course.id|string %}selected{% endif %}>
            {{ course.name }}
          </option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-3">
      <label for="date" class="form-label small text-uppercase text-muted">{{ _('Play date') }}</label>
      <input type="date" class="form-control" id="date" name="date" value="{{ filters.date }}">
    </div>
    <div class="col-md-3">
      <label for="status" class="form-label small text-uppercase text-muted">{{ _('Status') }}</label>
      <select name="status" id="status" class="form-select">
        <option value="">{{ _('All statuses') }}</option>
        {% for option in ['pending', 'confirmed', 'completed', 'cancelled'] %}
          <option value="{{ option }}" {% if filters.status == option %}selected{% endif %}>
            {{ option|capitalize }}
          </option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-2 d-grid">
      <button type="submit" class="btn btn-success">{{ _('Apply filters') }}</button>
    </div>
  </div>
</form>

<div class="card border-0 shadow-sm">
  <div class="table-responsive">
    <table class="table align-middle mb-0">
      <thead class="table-light">
        <tr>
          <th scope="col">#</th>
          <th scope="col">{{ _('Course') }}</th>
          <th scope="col">{{ _('Date') }}</th>
          <th scope="col">{{ _('Tee time') }}</th>
          <th scope="col">{{ _('Players') }}</th>
          <th scope="col">{{ _('Status') }}</th>
          <th scope="col">{{ _('Payment') }}</th>
          <th scope="col">{{ _('Check-in') }}</th>
          <th scope="col">{{ _('Customer') }}</th>
          <th scope="col" class="text-end">{{ _('Total (VND)') }}</th>
          <th scope="col"></th>
        </tr>
      </thead>
      <tbody>
        {% if bookings %}
          {% for booking in bookings %}
            <tr>
              <td class="fw-semibold">#{{ booking['id'] }}</td>
              <td>{{ booking['course_name'] }}</td>
              <td>{{ booking['play_date'] }}</td>
              <td>{{ booking['play_time'] }}</td>
              <td>{{ booking['players'] }}</td>
              <td>
                <span class="badge rounded-pill bg-light border text-capitalize">{{ booking['status'] }}</span>
              </td>
              <td>
                <span class="badge {{ 'bg-success-subtle text-success border-success' if booking['payment_status']=='paid' else 'bg-warning-subtle text-warning border-warning' }} border rounded-pill">
                  {{ booking['payment_status']|replace('_',' ')|capitalize }}
                </span>
              </td>
              <td>
                {% if booking['no_show'] %}
                  <span class="badge bg-warning text-dark">{{ _('No-show') }}</span>
                {% elif booking['check_out_at'] %}
                  <span class="badge bg-success-subtle text-success border border-success">{{ _('Checked-out') }}</span>
                {% elif booking['check_in_at'] %}
                  <span class="badge bg-info-subtle text-info border border-info">{{ _('Checked-in') }}</span>
                {% else %}
                  <span class="text-muted small">{{ _('Pending arrival') }}</span>
                {% endif %}
              </td>
              <td>
                <div class="fw-semibold">{{ booking['fullname'] or booking['username'] }}</div>
                <div class="text-muted small">{{ booking['phone'] or booking['email'] }}</div>
              </td>
              <td class="text-end fw-semibold">{{ '{:,.0f}'.format(booking['total_amount'] or 0) }}</td>
              <td class="text-end">
                <a href="{{ url_for('owner.booking_detail', lang=lang, booking_id=booking['id']) }}"
                   class="btn btn-sm btn-outline-success">
                  {{ _('Detail') }}
                </a>
              </td>
            </tr>
          {% endfor %}
        {% else %}
          <tr>
            <td colspan="11" class="text-center text-muted py-4">{{ _('No bookings found with the current filters.') }}</td>
          </tr>
        {% endif %}
      </tbody>
    </table>
  </div>
  {% if total_pages > 1 %}
    <div class="card-footer bg-white d-flex justify-content-between align-items-center">
      <span class="text-muted small">{{ _('Page %(page)s / %(total)s', page=page, total=total_pages) }}</span>
      <div class="btn-group">
        {% set prev_page = page - 1 %}
        {% set next_page = page + 1 %}
        <a class="btn btn-outline-success btn-sm {% if page <= 1 %}disabled{% endif %}"
           href="{{ url_for('owner.booking_list', lang=lang, page=prev_page, status=filters.status, date=filters.date, course_id=filters.course_id) }}">
          {{ _('Previous') }}
        </a>
        <a class="btn btn-outline-success btn-sm {% if page >= total_pages %}disabled{% endif %}"
           href="{{ url_for('owner.booking_list', lang=lang, page=next_page, status=filters.status, date=filters.date, course_id=filters.course_id) }}">
          {{ _('Next') }}
        </a>
      </div>
    </div>
  {% endif %}
</div>
{% endblock %}
