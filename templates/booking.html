{% extends 'base.html' %}

{% block head %}
<style>
  .slot-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
    gap: 0.75rem;
  }
  .slot-card {
    border: 1px solid #dfe3e8;
    border-radius: 0.5rem;
    padding: 0.75rem 0.85rem;
    background: #fff;
    text-align: left;
    transition: all 0.2s ease;
    width: 100%;
    min-height: 80px;
  }
  .slot-card .slot-time {
    font-weight: 600;
    font-size: 1.05rem;
    color: #212529;
  }
  .slot-card .slot-availability {
    font-size: 0.85rem;
  }
  .slot-card:not(.disabled):hover {
    border-color: #28a745;
    box-shadow: 0 0 0 3px rgba(40,167,69,.15);
  }
  .slot-card.active {
    border-color: #198754;
    background: #e9f7ef;
  }
  .slot-card.disabled,
  .slot-card[disabled] {
    border-color: #e0e0e0;
    background: #f8f9fa;
    color: #adb5bd;
    pointer-events: none;
    opacity: 0.7;
  }
  .login-prompt {
    min-height: 400px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
  }
  .filter-hint {
    font-size: 0.85rem;
  }
</style>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
  <div class="col-lg-7 col-xl-6">
    <div class="card border-0 shadow-sm mb-4">
      <div class="card-header bg-success text-white">
        <h5 class="mb-0">{{ _('Booking Courses') }}</h5>
      </div>
      <div class="card-body">
        <div class="alert alert-info mb-4" role="alert">
          <i class="bi bi-info-circle"></i>
          {{ _('Free cancellation up to %(hours)s hours before tee time. Need a new slot? Reschedule up to %(reschedule)s hours ahead.', hours=cancellation_window_hours, reschedule=reschedule_window_hours) }}
        </div>

        {% if session.get('user_id') and session.get('role') != 'admin' %}
          <form id="booking-form" method="post">
            <div class="mb-3">
              <label class="form-label">{{ _('Filter courses') }}</label>
              <div class="row g-2 align-items-end">
                <div class="col-sm-6">
                  <select id="filter-location" class="form-select">
                    <option value="">{{ _('All locations') }}</option>
                    {% for loc in location_options %}
                      <option value="{{ loc }}">{{ loc }}</option>
                    {% endfor %}
                  </select>
                
                </div>
                <div class="col-sm-3">
                  <select id="filter-holes" class="form-select">
                    <option value="">{{ _('Any holes') }}</option>
                    {% for holes in hole_options %}
                      <option value="{{ holes }}">{{ holes }} {{ _('holes') }}</option>
                    {% endfor %}
                  </select>
             
                </div>
                <div class="col-sm-3">
                  <input type="number" id="filter-price" class="form-control" placeholder="{{ _('Price (VND)') }}" min="0" step="500000">
          
                </div>
              </div>
              <div id="course-filter-empty" class="alert alert-warning mt-3 d-none" role="alert">
                {{ _('No course matches your filters. Adjust your filters to continue.') }}
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label">{{ _('Course') }}</label>
              <select id="course-select" name="course_id" class="form-select" required>
                {% for c in courses %}
                  <option value="{{ c.id }}">{{ c.name }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="mb-3">
              <label class="form-label">{{ _('Play Date') }}</label>
              <input type="date" id="play_date" name="play_date" class="form-control" required>
            </div>

            <div class="mb-3">
              <label class="form-label d-flex justify-content-between align-items-center">
                <span>{{ _('Time Slot') }}</span>
                <small class="text-muted" id="slot-hint">{{ _('Tap a slot to select. Availability updates live.') }}</small>
              </label>
              <input type="hidden" name="play_time" id="selected-time" required>
              <div id="slot-grid" class="slot-grid">
                {% for t in time_slots %}
                  <button type="button" class="slot-card" data-time="{{ t }}">
                    <div class="slot-time">{{ t }}</div>
                    <div class="slot-availability text-muted">{{ _('Checking...') }}</div>
                  </button>
                {% endfor %}
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label">{{ _('Players') }}</label>
              <select id="players-select" name="players" class="form-select">
                {% for n in range(1, slot_capacity + 1) %}
                  <option value="{{ n }}">{{ n }} {{ _('people') }}</option>
                {% endfor %}
              </select>
              <div class="form-text text-muted">{{ _('Maximum %(slots)s players per tee time.', slots=slot_capacity) }}</div>
            </div>

            <div class="mb-3">
              <label class="form-label">{{ _('Amenities') }}</label>
              <div class="form-check">
                <input class="form-check-input svc-checkbox" type="checkbox" id="rent_clubs" name="rent_clubs" value="rent_clubs" checked>
                <label class="form-check-label" for="rent_clubs">{{ _('Rent golf clubs') }}</label>
              </div>
              <div class="form-check">
                <input class="form-check-input svc-checkbox" type="checkbox" id="caddy" name="caddy" value="caddy" checked>
                <label class="form-check-label" for="caddy">{{ _('Caddy') }}</label>
              </div>
              <div class="form-check">
                <input class="form-check-input svc-checkbox" type="checkbox" id="cart" name="cart" value="cart" checked>
                <label class="form-check-label" for="cart">{{ _('Golf cart') }}</label>
              </div>
            </div>

            {% if deposit_percent > 0 %}
            <div class="mb-3">
              <label class="form-label">{{ _('Payment option') }}</label>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="payment_option" id="payment-deposit" value="vnpay_deposit" checked>
                <label class="form-check-label" for="payment-deposit">
                  {{ _('Pay %(percent)s%% deposit via VNPay now', percent=deposit_percent) }}
                  <span class="d-block text-muted small" id="payment-deposit-summary"></span>
                </label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="payment_option" id="payment-bank" value="bank_transfer">
                <label class="form-check-label" for="payment-bank">
                  {{ _('Pay %(percent)s%% deposit via bank transfer (Vietcombank)', percent=deposit_percent) }}
                  <span class="d-block text-muted small" id="payment-bank-summary"></span>
                </label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="payment_option" id="payment-arrival" value="pay_on_arrival">
                <label class="form-check-label" for="payment-arrival">
                  {{ _('Pay at the course (booking stays pending until staff confirm)') }}
                </label>
              </div>
            </div>
            {% else %}
            <input type="hidden" name="payment_option" value="pay_on_arrival">
            {% endif %}
          </form>

          <div id="booking-summary" class="card border-0 shadow-sm p-3">
            <div class="d-flex justify-content-between"><span>{{ _('Green fee') }}</span><span id="sum-green">0 VND</span></div>
            <div class="d-flex justify-content-between"><span>{{ _('Caddy') }} (<span id="sum-caddy-count">0</span>)</span><span id="sum-caddy">0 VND</span></div>
            <div class="d-flex justify-content-between"><span>{{ _('Rent golf clubs') }} (<span id="sum-rent-count">0</span>)</span><span id="sum-rent">0 VND</span></div>
            <div class="d-flex justify-content-between"><span>{{ _('Golf cart') }} (<span id="sum-cart-count">0</span>)</span><span id="sum-cart">0 VND</span></div>
            <div class="d-flex justify-content-between"><span>{{ _('Insurance') }}</span><span id="sum-insurance">0 VND</span></div>
            <hr>
            <div class="d-flex justify-content-between"><strong>{{ _('Total') }}</strong><strong id="sum-total">0 VND</strong></div>
            {% if deposit_percent > 0 %}
            <div id="deposit-row" class="d-flex justify-content-between">
              <span id="deposit-label">{{ _('Deposit due now (%(percent)s%%)', percent=deposit_percent) }}</span>
              <span id="sum-deposit">0 VND</span>
            </div>
            {% endif %}
            <div id="balance-row" class="d-flex justify-content-between">
              <span id="balance-label">{{ _('Balance due at course') }}</span>
              <span id="sum-balance">0 VND</span>
            </div>
            <p class="small text-muted mt-2" id="payment-summary-note"></p>
            <button form="booking-form" id="submit-button" type="submit" class="btn btn-success w-100 mt-3" disabled>{{ _('Book now') }}</button>
          </div>
        {% elif session.get('role') == 'admin' %}
          <div class="login-prompt text-center">
            <i class="bi bi-shield-lock-fill" style="font-size: 4rem; color: #dc3545;"></i>
            <h4 class="mt-3 mb-3">{{ _('Admin Access Restricted') }}</h4>
            <p class="text-muted mb-4">{{ _('Administrators cannot make bookings. Please use a regular user account.') }}</p>
            <a href="{{ url_for('admin.dashboard', lang=lang) }}" class="btn btn-primary">
              <i class="bi bi-speedometer2 me-2"></i>
              {{ _('Go to Admin Dashboard') }}
            </a>
          </div>
        {% else %}
          <div class="login-prompt text-center">
            <i class="bi bi-calendar-check" style="font-size: 4rem; color: #28a745;"></i>
            <h4 class="mt-3 mb-3">{{ _('Login Required') }}</h4>
            <p class="text-muted mb-4">{{ _('Please login to access our booking system and reserve your tee time.') }}</p>
            <button type="button" class="btn btn-success btn-lg px-5" data-bs-toggle="modal" data-bs-target="#loginModal">
              <i class="bi bi-box-arrow-in-right me-2"></i>
              {{ _('Login to Continue') }}
            </button>
            <p class="mt-4 small text-muted">
              {{ _("Don't have an account?") }}
              <a href="#" data-bs-toggle="modal" data-bs-target="#registerModal" class="text-decoration-none text-success fw-semibold">
                {{ _('Register here') }}
              </a>
            </p>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

{% if session.get('user_id') and session.get('role') != 'admin' %}
<script>
  const tierData = {{ tier_prices_by_course|tojson }};
  const servicePrices = {{ service_prices|tojson }};
  const courseMeta = {{ courses_meta|tojson }};
  const availabilityUrl = {{ availability_url|tojson }};
  const slotCapacity = {{ slot_capacity }};
  const minAdvanceMinutes = {{ min_advance_minutes }};
  const labels = {
    loading: {{ _('Checking...')|tojson }},
    full: {{ _('Full')|tojson }},
    closed: {{ _('Closed')|tojson }},
    availableSingular: {{ _('1 spot left')|tojson }},
    availablePlural: {{ _('%(count)s spots left', count='%(count)s')|tojson }},
    selected: {{ _('Selected')|tojson }},
    courseFilterEmpty: {{ _('No course matches your filters. Adjust your filters to continue.')|tojson }},
    depositLabel: {{ _('Deposit due now (%(percent)s%%)', percent='%(percent)s')|tojson }},
    balanceLabelDeposit: {{ _('Balance due at course')|tojson }},
    balanceLabelArrival: {{ _('Total to pay at course')|tojson }},
    depositNoteVnpay: {{ _('Pay %(amount)s VND via VNPay now and settle the remainder at the clubhouse.', amount='%(amount)s')|tojson }},
    depositNoteBank: {{ _('Transfer %(amount)s VND to our Vietcombank account. We will confirm once received.', amount='%(amount)s')|tojson }},
    payLaterNote: {{ _('Pay the full amount at the course. Your booking remains pending until staff confirm.')|tojson }},
    depositOptionSummaryVnpay: {{ _('Pay %(amount)s VND via VNPay now.', amount='%(amount)s')|tojson }},
    depositOptionSummaryBank: {{ _('Transfer %(amount)s VND via bank transfer now.', amount='%(amount)s')|tojson }}
  };
  const currencySymbol = ' VND';

  const dateInput = document.getElementById('play_date');
  const courseSelect = document.getElementById('course-select');
  const playersSelect = document.getElementById('players-select');
  const selectedTimeInput = document.getElementById('selected-time');
  const submitButton = document.getElementById('submit-button');
  const slotButtons = Array.from(document.querySelectorAll('.slot-card'));
  const filterLocation = document.getElementById('filter-location');
  const filterHoles = document.getElementById('filter-holes');
  const filterPrice = document.getElementById('filter-price');

  const courseFilterEmptyAlert = document.getElementById('course-filter-empty');
  const paymentOptions = Array.from(document.querySelectorAll('input[name="payment_option"]'));
  const depositPercent = {{ deposit_percent }};
  const depositRow = document.getElementById('deposit-row');
  const depositLabelEl = document.getElementById('deposit-label');
  const depositValue = document.getElementById('sum-deposit');
  const balanceRow = document.getElementById('balance-row');
  const balanceLabelEl = document.getElementById('balance-label');
  const balanceValue = document.getElementById('sum-balance');
  const paymentNote = document.getElementById('payment-summary-note');
  const depositOptionSummary = document.getElementById('payment-deposit-summary');
  const bankTransferSummary = document.getElementById('payment-bank-summary');

  let availabilityRequestId = 0;

  if (depositRow && depositPercent <= 0) {
    depositRow.classList.add('d-none');
  }


  function fmt(value) {
    return (value || 0).toLocaleString('vi-VN') + currencySymbol;
  }

  function resetSummary() {
    document.getElementById('sum-green').textContent = fmt(0);
    document.getElementById('sum-caddy-count').textContent = '0';
    document.getElementById('sum-caddy').textContent = fmt(0);
    document.getElementById('sum-rent-count').textContent = '0';
    document.getElementById('sum-rent').textContent = fmt(0);
    document.getElementById('sum-cart-count').textContent = '0';
    document.getElementById('sum-cart').textContent = fmt(0);
    document.getElementById('sum-insurance').textContent = fmt(0);
    document.getElementById('sum-total').textContent = fmt(0);
    if (depositValue) depositValue.textContent = fmt(0);
    if (balanceValue) balanceValue.textContent = fmt(0);
    if (paymentNote) paymentNote.textContent = '';
    if (depositOptionSummary) depositOptionSummary.textContent = '';
    if (bankTransferSummary) bankTransferSummary.textContent = '';
  }
  function updateSummary() {
    const dateValue = dateInput.value;
    const timeValue = selectedTimeInput.value;
    const courseId = Number(courseSelect.value);
    const players = Number(playersSelect.value || 0);

    if (!dateValue || !timeValue || !courseId) {
      resetSummary();
      return;
    }

    const dt = new Date(dateValue + 'T' + timeValue);
    const day = dt.getDay();
    let tier = (day === 0 || day === 6) ? 'weekend' : 'weekday';
    if (dt.getHours() >= 14) {
      tier = 'twilight';
    }

    const pricing = tierData[courseId] || {};
    const greenUnit = pricing[tier] || 0;
    const green = greenUnit * players;
    document.getElementById('sum-green').textContent = fmt(green);

    const hasCaddy = document.getElementById('caddy').checked;
    const hasClubs = document.getElementById('rent_clubs').checked;
    const hasCart = document.getElementById('cart').checked;

    const caddyCount = hasCaddy ? players : 0;
    const rentCount = hasClubs ? players : 0;
    const cartCount = hasCart ? players : 0;

    const caddyFee = servicePrices.caddy * caddyCount;
    const rentFee = servicePrices.rent_clubs * rentCount;
    const cartFee = servicePrices.cart * cartCount;
    const insuranceFee = servicePrices.insurance * players;

    document.getElementById('sum-caddy-count').textContent = caddyCount;
    document.getElementById('sum-caddy').textContent = fmt(caddyFee);
    document.getElementById('sum-rent-count').textContent = rentCount;
    document.getElementById('sum-rent').textContent = fmt(rentFee);
    document.getElementById('sum-cart-count').textContent = cartCount;
    document.getElementById('sum-cart').textContent = fmt(cartFee);
    document.getElementById('sum-insurance').textContent = fmt(insuranceFee);

    const total = green + caddyFee + rentFee + cartFee + insuranceFee;
    document.getElementById('sum-total').textContent = fmt(total);

    const selectedPayment = paymentOptions.find(opt => opt.checked)?.value || 'pay_on_arrival';
    let depositAmount = 0;
    let balanceAmount = total;

    const depositLabelTemplate = (labels.depositLabel || '').toString();
    const depositNoteVnpay = (labels.depositNoteVnpay || labels.depositNote || '').toString();
    const depositNoteBank = (labels.depositNoteBank || labels.depositNote || '').toString();
    const depositSummaryVnpay = (labels.depositOptionSummaryVnpay || labels.depositOptionSummary || '').toString();
    const depositSummaryBank = (labels.depositOptionSummaryBank || labels.depositOptionSummary || '').toString();

    if (depositPercent > 0 && (selectedPayment === 'vnpay_deposit' || selectedPayment === 'bank_transfer')) {
      depositAmount = Math.max(Math.round(total * depositPercent / 100), 0);
      balanceAmount = Math.max(total - depositAmount, 0);
      if (depositRow) depositRow.classList.remove('d-none');
      if (depositLabelEl && depositLabelTemplate) {
        depositLabelEl.textContent = depositLabelTemplate.replace('%(percent)s', depositPercent);
      }
      if (balanceLabelEl) balanceLabelEl.textContent = labels.balanceLabelDeposit;
      if (selectedPayment === 'vnpay_deposit') {
        if (paymentNote && depositNoteVnpay) paymentNote.textContent = depositNoteVnpay.replace('%(amount)s', depositAmount.toLocaleString('vi-VN'));
        if (depositOptionSummary && depositSummaryVnpay) depositOptionSummary.textContent = depositSummaryVnpay.replace('%(amount)s', depositAmount.toLocaleString('vi-VN'));
        if (bankTransferSummary) bankTransferSummary.textContent = '';
      } else {
        if (paymentNote && depositNoteBank) paymentNote.textContent = depositNoteBank.replace('%(amount)s', depositAmount.toLocaleString('vi-VN'));
        if (bankTransferSummary && depositSummaryBank) bankTransferSummary.textContent = depositSummaryBank.replace('%(amount)s', depositAmount.toLocaleString('vi-VN'));
        if (depositOptionSummary) depositOptionSummary.textContent = '';
      }
    } else {
      if (depositRow) depositRow.classList.add('d-none');
      if (balanceLabelEl) balanceLabelEl.textContent = labels.balanceLabelArrival;
      if (paymentNote) paymentNote.textContent = labels.payLaterNote;
      if (depositOptionSummary) depositOptionSummary.textContent = '';
      if (bankTransferSummary) bankTransferSummary.textContent = '';
      depositAmount = 0;
      balanceAmount = total;
    }

    if (depositValue) depositValue.textContent = fmt(depositAmount);
    if (balanceValue) balanceValue.textContent = fmt(balanceAmount);
  }
  function enableSubmit(hasSelection) {
    if (submitButton) {
      submitButton.disabled = !hasSelection;
    }
  }

  function clearSlotSelection() {
    slotButtons.forEach(btn => btn.classList.remove('active'));
    selectedTimeInput.value = '';
    enableSubmit(false);
  }

  function selectSlot(button) {
    slotButtons.forEach(btn => btn.classList.remove('active'));
    button.classList.add('active');
    selectedTimeInput.value = button.dataset.time;
    enableSubmit(true);
    updateSummary();
  }

  function minutesUntil(dateString, timeString) {
    const now = new Date();
    const target = new Date(dateString + 'T' + timeString);
    return (target - now) / 60000;
  }

  function formatAvailability(remaining) {
    if (remaining === 1) {
      return labels.availableSingular;
    }
    return labels.availablePlural.replace('%(count)s', remaining);
  }

  function setSlotState(button, { remaining, statusText, selectable }) {
    const availabilityEl = button.querySelector('.slot-availability');
    availabilityEl.textContent = statusText;
    if (selectable) {
      button.disabled = false;
      button.classList.remove('disabled');
    } else {
      button.disabled = true;
      button.classList.add('disabled');
      if (button.classList.contains('active')) {
        button.classList.remove('active');
      }
    }
  }

  function setSlotsLoading() {
    slotButtons.forEach(button => {
      setSlotState(button, { remaining: 0, statusText: labels.loading, selectable: false });
    });
    clearSlotSelection();
  }

  function setSlotsUnavailable(message) {
    slotButtons.forEach(button => {
      setSlotState(button, { remaining: 0, statusText: message, selectable: false });
    });
    clearSlotSelection();
  }

  function applyAvailability(slots, dateValue) {
    const slotMap = new Map(slots.map(slot => [slot.time, slot]));
    let firstSelectable = null;
    const today = new Date().toISOString().split('T')[0];

    slotButtons.forEach(button => {
      const slotInfo = slotMap.get(button.dataset.time) || { remaining: slotCapacity };
      let remaining = Math.max(0, slotInfo.remaining);
      let selectable = remaining > 0;
      let statusText = remaining > 0 ? formatAvailability(remaining) : labels.full;

      if (dateValue === today) {
        const mins = minutesUntil(dateValue, button.dataset.time);
        if (mins <= minAdvanceMinutes) {
          selectable = false;
          statusText = labels.closed;
        }
      }

      setSlotState(button, { remaining, statusText, selectable });
      if (selectable && !firstSelectable) {
        firstSelectable = button;
      }
    });

    const currentSelection = slotButtons.find(btn => btn.classList.contains('active') && !btn.disabled);
    if (currentSelection) {
      selectedTimeInput.value = currentSelection.dataset.time;
      enableSubmit(true);
    } else if (firstSelectable) {
      selectSlot(firstSelectable);
    } else {
      clearSlotSelection();
    }
  }

  async function updateAvailability() {
    const courseId = Number(courseSelect.value);
    const playDate = dateInput.value;

    if (!courseId || !playDate) {
      setSlotsUnavailable(labels.loading);
      return;
    }

    const requestId = ++availabilityRequestId;
    setSlotsLoading();

    try {
      const params = new URLSearchParams({ course_id: courseId, play_date: playDate });
      const response = await fetch(`${availabilityUrl}?${params.toString()}`);
      if (!response.ok) {
        throw new Error('Failed to fetch availability');
      }
      const data = await response.json();
      if (requestId !== availabilityRequestId) {
        return;
      }
      applyAvailability(data.slots || [], playDate);
      updateSummary();
    } catch (error) {
      console.error('Availability lookup failed', error);
      setSlotsUnavailable(labels.loading);
    }
  }

  function applyCourseFilters(triggerAvailability = true) {
    const locationValue = filterLocation.value;
    const holesValue = filterHoles.value;
    const priceValue = Number(filterPrice.value || 0);
    const previousSelection = courseSelect.value;

    courseSelect.innerHTML = '';

    const matchingCourses = courseMeta.filter(meta => {
      if (locationValue && meta.location !== locationValue) {
        return false;
      }
      if (holesValue && String(meta.holes || '') !== holesValue) {
        return false;
      }
      if (priceValue && meta.min_price && meta.min_price > priceValue) {
        return false;
      }
      return true;
    });

    matchingCourses.forEach(meta => {
      const option = document.createElement('option');
      option.value = meta.id;
      option.textContent = meta.name;
      courseSelect.appendChild(option);
    });

    if (matchingCourses.length === 0) {
      courseSelect.disabled = true;
      courseFilterEmptyAlert.classList.remove('d-none');
      setSlotsUnavailable(labels.courseFilterEmpty);
      return;
    }

    courseSelect.disabled = false;
    courseFilterEmptyAlert.classList.add('d-none');

    const shouldRestore = matchingCourses.some(meta => String(meta.id) === previousSelection);
    if (shouldRestore) {
      courseSelect.value = previousSelection;
    }

    if (!courseSelect.value && courseSelect.options.length > 0) {
      courseSelect.selectedIndex = 0;
    }

    if (triggerAvailability) {
      updateAvailability();
    }
    updateSummary();
  }

  function initializeDatePicker() {
    const today = new Date().toISOString().split('T')[0];
    dateInput.value = today;
    dateInput.min = today;
  }

  slotButtons.forEach(button => {
    button.addEventListener('click', () => {
      if (!button.disabled) {
        selectSlot(button);
      }
    });
  });

  filterLocation.addEventListener('change', () => applyCourseFilters());
  filterHoles.addEventListener('change', () => applyCourseFilters());
  filterPrice.addEventListener('input', () => applyCourseFilters(false));
  filterPrice.addEventListener('change', () => applyCourseFilters());
  courseSelect.addEventListener('change', () => {
    updateAvailability();
    updateSummary();
  });
  dateInput.addEventListener('change', () => {
    updateAvailability();
    updateSummary();
  });
  playersSelect.addEventListener('change', updateSummary);
  paymentOptions.forEach(option => option.addEventListener('change', updateSummary));
  document.querySelectorAll('.svc-checkbox').forEach(box => box.addEventListener('change', updateSummary));

  initializeDatePicker();
  applyCourseFilters();
  updateAvailability();
  updateSummary();
</script>
{% endif %}
{% endblock %}

