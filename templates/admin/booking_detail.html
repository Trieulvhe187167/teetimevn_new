{% extends 'admin/dashboard.html' %}

{% block title %}{{ _('Booking') }} #{{ booking.id }} - Admin{% endblock %}

{% block admin_content %}
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2>{{ _('Booking Detail') }} #{{ booking.id }}</h2>
    <a href="{{ url_for('admin.booking_list', lang=lang) }}" class="btn btn-secondary">
      <i class="bi bi-arrow-left"></i> {{ _('Back to List') }}
    </a>
  </div>

  <div class="row">
    <!-- Main Booking Info -->
    <div class="col-lg-8">
      <div class="card mb-4">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">{{ _('Booking Information') }}</h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <h6 class="text-muted">{{ _('Customer Information') }}</h6>
              <p><strong>{{ _('Name') }}:</strong> {{ booking.fullname or booking.username }}</p>
              <p><strong>{{ _('Email') }}:</strong> <a href="mailto:{{ booking.email }}">{{ booking.email }}</a></p>
              <p><strong>{{ _('Phone') }}:</strong> {{ booking.phone or _('Not provided') }}</p>
              <p><strong>{{ _('Username') }}:</strong> {{ booking.username }}</p>
            </div>
            <div class="col-md-6">
              <h6 class="text-muted">{{ _('Course Information') }}</h6>
              <p><strong>{{ _('Course') }}:</strong> {{ booking.course_name }}</p>
              <p><strong>{{ _('Address') }}:</strong> {{ booking.address }}</p>
              <p><strong>{{ _('Par/Holes') }}:</strong> {{ booking.par }} / {{ booking.holes }}</p>
              <p><strong>{{ _('Length') }}:</strong> {{ booking.length_yards }} yards</p>
            </div>
          </div>
          
          <hr>
          
          <div class="row">
            <div class="col-md-6">
              <h6 class="text-muted">{{ _('Booking Details') }}</h6>
              <p><strong>{{ _('Play Date') }}:</strong> <span class="text-primary">{{ booking.play_date }}</span></p>
              <p><strong>{{ _('Tee Time') }}:</strong> <span class="text-primary">{{ booking.play_time }}</span></p>
              <p><strong>{{ _('Players') }}:</strong> {{ booking.players }}</p>
              <p><strong>{{ _('Created') }}:</strong> {{ booking.created_at_formatted }}</p>
              <p><strong>{{ _('Updated') }}:</strong> {{ booking.updated_at_formatted or _('Never') }}</p>
            </div>
            <div class="col-md-6">
              <h6 class="text-muted">{{ _('Services') }}</h6>
              <ul class="list-unstyled">
                <li>
                  {% if booking.has_caddy %}
                    <i class="bi bi-check-circle-fill text-success"></i>
                  {% else %}
                    <i class="bi bi-x-circle text-muted"></i>
                  {% endif %}
                  {{ _('Caddy Service') }}
                </li>
                <li>
                  {% if booking.has_cart %}
                    <i class="bi bi-check-circle-fill text-success"></i>
                  {% else %}
                    <i class="bi bi-x-circle text-muted"></i>
                  {% endif %}
                  {{ _('Golf Cart') }}
                </li>
                <li>
                  {% if booking.has_rent_clubs %}
                    <i class="bi bi-check-circle-fill text-success"></i>
                  {% else %}
                    <i class="bi bi-x-circle text-muted"></i>
                  {% endif %}
                  {{ _('Golf Club Rental') }}
                </li>
              </ul>
            </div>
          </div>
          
          <hr>
          
          <!-- Pricing -->
          <h6 class="text-muted">{{ _('Pricing Details') }}</h6>
          <table class="table table-sm">
            <tbody>
              <tr>
                <td>{{ _('Green Fee') }}</td>
                <td class="text-end">{{ "{:,.0f}".format(booking.green_fee) }} VND</td>
              </tr>
              <tr>
                <td>{{ _('Additional Services') }}</td>
                <td class="text-end">{{ "{:,.0f}".format(booking.services_fee) }} VND</td>
              </tr>
              <tr>
                <td>{{ _('Insurance') }}</td>
                <td class="text-end">{{ "{:,.0f}".format(booking.insurance_fee) }} VND</td>
              </tr>
              <tr class="table-success">
                <th>{{ _('Total Amount') }}</th>
                <th class="text-end">{{ "{:,.0f}".format(booking.total_amount) }} VND</th>
              </tr>
            </tbody>
          </table>
          
          <!-- Notes -->
          {% if booking.notes %}
          <hr>
          <h6 class="text-muted">{{ _('Notes') }}</h6>
          <p class="mb-0">{{ booking.notes }}</p>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Status & Actions -->
    <div class="col-lg-4">

<!-- Payment Summary -->
<div class="card mb-4">
  <div class="card-header bg-success text-white">
    <h5 class="mb-0">{{ _('Payment Overview') }}</h5>
  </div>
  <div class="card-body">
    {% set payment_status = (booking.payment_status or 'unpaid')|lower %}
    {% if payment_status == 'paid' %}
      {% set payment_badge_class = 'bg-success' %}
      {% set payment_badge_label = _('Paid in full') %}
    {% elif payment_status == 'partially_paid' %}
      {% set payment_badge_class = 'bg-info text-dark' %}
      {% set payment_badge_label = _('Deposit received') %}
    {% elif payment_status == 'failed' %}
      {% set payment_badge_class = 'bg-danger' %}
      {% set payment_badge_label = _('Payment failed') %}
    {% else %}
      {% set payment_badge_class = 'bg-warning text-dark' %}
      {% set payment_badge_label = _('Unpaid') %}
    {% endif %}

    {% set method_map = {
      'vnpay_deposit': _('VNPay deposit'),
      'bank_transfer': _('Bank transfer'),
      'pay_on_arrival': _('Pay on arrival')
    } %}
    {% set method_key = (booking.payment_method or '')|lower %}
    {% set method_label = method_map.get(method_key, booking.payment_method or _('Not specified')) %}

    <p class="mb-3">
      <strong>{{ _('Payment status') }}:</strong>
      <span class="badge {{ payment_badge_class }}">{{ payment_badge_label }}</span>
    </p>
    <ul class="list-unstyled mb-3">
      <li><strong>{{ _('Amount paid') }}:</strong> {{ "{:,.0f}".format(booking.paid_amount or 0) }} VND</li>
      <li><strong>{{ _('Balance due') }}:</strong> {{ "{:,.0f}".format(booking.balance_due or 0) }} VND</li>
      {% if booking.deposit_amount %}
      <li><strong>{{ _('Deposit required') }}:</strong> {{ "{:,.0f}".format(booking.deposit_amount) }} VND</li>
      {% endif %}
      <li><strong>{{ _('Payment method') }}:</strong> {{ method_label }}</li>
      <li><strong>{{ _('Gateway') }}:</strong> {{ booking.payment_gateway or _('Manual') }}</li>
      {% if booking.payment_gateway_ref %}
      <li><strong>{{ _('Reference') }}:</strong> {{ booking.payment_gateway_ref }}</li>
      {% endif %}
      {% if booking.payment_verified_at %}
      <li><strong>{{ _('Last verified at') }}:</strong> {{ booking.payment_verified_at }}</li>
      {% endif %}
    </ul>

    {% if payment_status == 'paid' %}
    <div class="alert alert-success py-2" role="alert">
      <i class="bi bi-check-circle-fill me-2"></i> {{ _('This booking is fully settled.') }}
    </div>
    {% endif %}

    {% set suggested_amount = booking.balance_due if booking.balance_due else (booking.deposit_amount if booking.deposit_amount else (booking.total_amount if (booking.total_amount and (booking.paid_amount or 0) == 0) else '')) %}
    <hr>
    <form method="post" action="{{ url_for('admin.confirm_booking_payment', lang=lang, booking_id=booking.id) }}">
      <div class="mb-3">
        <label class="form-label">{{ _('Amount received (VND)') }}</label>
        <input type="number" name="amount" class="form-control" min="1" step="1" value="{{ suggested_amount }}" required>
        <div class="form-text">{{ _('Current balance: %(amount)s VND', amount="{:,.0f}".format(booking.balance_due or 0)) }}</div>
      </div>
      <div class="mb-3">
        <label class="form-label">{{ _('Reference / receipt number') }}</label>
        <input type="text" name="reference" class="form-control" placeholder="{{ _('Optional transaction code') }}">
        <div class="form-text">{{ _('Optional: bank reference, POS slip, etc.') }}</div>
      </div>
      <input type="hidden" name="gateway" value="manual_admin">
      <button type="submit" class="btn btn-success w-100">
        <i class="bi bi-cash-coin"></i> {{ _('Confirm payment and notify customer') }}
      </button>
      <p class="small text-muted mt-2 mb-0">{{ _('An email receipt will be sent to the customer automatically.') }}</p>
    </form>
  </div>
</div>

      <!-- Current Status -->
      <div class="card mb-4">
        <div class="card-header bg-info text-white">
          <h5 class="mb-0">{{ _('Status Management') }}</h5>
        </div>
        <div class="card-body">
          <p class="mb-3">
            <strong>{{ _('Current Status') }}:</strong>
            <span class="badge fs-6
              {% if booking.status == 'confirmed' %}bg-success
              {% elif booking.status == 'pending' %}bg-warning text-dark
              {% else %}bg-secondary{% endif %}">
              {{ _(booking.status.title()) }}
            </span>
          </p>
          
          <form method="post" action="{{ url_for('admin.update_booking_status', lang=lang, booking_id=booking.id) }}">
            <div class="mb-3">
              <label class="form-label">{{ _('Change Status') }}</label>
              <select name="status" class="form-select" required>
                <option value="">{{ _('Select Status') }}</option>
                <option value="pending" {% if booking.status == 'pending' %}selected{% endif %}>{{ _('Pending') }}</option>
                <option value="confirmed" {% if booking.status == 'confirmed' %}selected{% endif %}>{{ _('Confirmed') }}</option>
                <option value="cancelled" {% if booking.status == 'cancelled' %}selected{% endif %}>{{ _('Cancelled') }}</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">{{ _('Notes (will be sent to customer)') }}</label>
              <textarea name="notes" class="form-control" rows="3" 
                        placeholder="{{ _('Optional message for customer') }}"></textarea>
            </div>
            <button type="submit" class="btn btn-primary w-100">
              <i class="bi bi-check-circle"></i> {{ _('Update Status') }}
            </button>
          </form>
        </div>
      </div>

      <!-- Add Note -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0">{{ _('Add/Update Note') }}</h5>
        </div>
        <div class="card-body">
          <form method="post" action="{{ url_for('admin.add_booking_note', lang=lang, booking_id=booking.id) }}">
            <div class="mb-3">
              <textarea name="notes" class="form-control" rows="3" 
                        placeholder="{{ _('Internal notes (not sent to customer)') }}">{{ booking.notes or '' }}</textarea>
            </div>
            <button type="submit" class="btn btn-secondary w-100">
              <i class="bi bi-pencil"></i> {{ _('Save Note') }}
            </button>
          </form>
        </div>
      </div>

      <!-- Status History -->
      {% if status_history %}
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">{{ _('Status History') }}</h5>
        </div>
        <div class="card-body">
          <div class="timeline">
            {% for history in status_history %}
            <div class="mb-3">
              <small class="text-muted">{{ history.created_at }}</small>
              <p class="mb-1">
                <span class="badge bg-secondary">{{ history.old_status }}</span>
                <i class="bi bi-arrow-right mx-2"></i>
                <span class="badge 
                  {% if history.new_status == 'confirmed' %}bg-success
                  {% elif history.new_status == 'pending' %}bg-warning text-dark
                  {% else %}bg-secondary{% endif %}">
                  {{ history.new_status }}
                </span>
              </p>
              <small>{{ _('By') }}: {{ history.changed_by }}</small>
              {% if history.notes %}
                <br><small class="text-muted">{{ history.notes }}</small>
              {% endif %}
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
      {% endif %}
    </div>
  </div>
{% endblock %}